# V1 Design Document — Age of the Crystal Ball

**Date:** 2026-02-06
**Status:** Draft — awaiting prioritisation
**Target:** GR Company Competition (1-2 week build window)
**Judges on:** Wow factor + Practical utility + Technical depth (equally weighted)

---

## Current State (V0)

Working `npm run simulate` with:
- Express server + simulator generating 12 sessions across 5 groups
- Three.js isometric scene with orthographic camera, shadows, CSS2DRenderer
- 20x20 procedural terrain (grass, water, hills)
- 8 building types, one per group
- Unit meshes with 5 accessory types
- 5 activity animation pairs
- 4-state visual system (active/awaiting/idle/stale)
- Click-to-select units and buildings with detail panel
- HUD bar with counts and awaiting pulse alert
- Camera panning

---

## Pillar 1: The Map

### 1.1 Biome System

Replace the uniform grass grid with distinct terrain zones. The 20x20 grid (expandable to 30x30) is divided into quadrants, each with a biome:

- **Forest:** Dense green tiles, darker grass variants, tree meshes (cone on cylinder) scattered between buildings. Earthy, lush.
- **Desert:** Sandy tiles (PALETTE.sandstone), rock formation meshes (irregular stacked boxes), warm tones. Sparse, open.
- **Mountain:** Stepped terrain at map edges, tall block formations (height 0.5-1.5), grey-brown stone. Dramatic backdrop.
- **Meadow:** Default biome. Current grass tiles with wildflower colour pops (tiny coloured spheres on ground).

Biome assignment is procedural per load. River always cuts through, bridge mesh where paths cross water.

### 1.2 Zoom

Scroll-wheel zoom between `viewSize` 6 (close tactical) and 30 (wide strategic).

Zoom affects detail visibility:
- **Wide (>20):** Only platoon name labels, units are colour-coded dots, health bars visible
- **Medium (10-20):** Current default. Units visible with accessories, names on hover
- **Close (<10):** Full detail. Rank badges, particles, accessory detail, unit names always visible

Implementation: adjust `OrthographicCamera` frustum on wheel event, smooth-lerp the transition over 300ms.

### 1.3 Camera Rotation

90-degree snap rotation around the Y axis. Press `Q`/`E` or click rotation arrows in the HUD. Smooth 500ms tween between angles. Four fixed orientations (NE, SE, SW, NW). Camera target point stays fixed during rotation.

### 1.4 GR Branding

- **Town Hall:** A permanent central building (larger than others, distinct architecture — stone keep with GR banner). Always present at map centre. Clicking it opens the War Room panel.
- **Colour integration:** GR navy (#1B2A4A), white, and red (#C41E3A) woven into the palette as accent colours — banner fabrics, roof trim, unit sashes.
- **Stone monument:** A small GR logo carved into a standing stone mesh near the Town Hall. Subtle, not gaudy.

### 1.5 Procedural Variety

Each page load generates a different map via seeded RNG. River path varies (2-3 templates: straight diagonal, S-curve, Y-fork). Biome quadrant assignment shuffles. Building placement randomised within biome constraints. Paths auto-generated connecting all buildings to the Town Hall via A* on the tile grid.

---

## Pillar 2: The Army — Emergent Structure

### 2.1 Platoons (= Working Directory Groups)

Already implemented in V0. Each unique `cwd` is a platoon. Enhancements:
- **Platoon colour accent:** Generated from hash of group name. Applied as a subtle coloured sash/banner on each unit in the platoon. Consistent across reloads.
- **Platoon banner mesh:** A small flag on a pole next to each building. Uses the platoon accent colour.

### 2.2 Divisions (= Auto-Inferred)

Divisions emerge from directory proximity — the backend groups platoons by nearest common ancestor directory.

Example:
```
/home/tomek/projects/SimExLab     ─┐
/home/tomek/projects/Q1TouchPoint  ├─ Division: "projects"
/home/tomek/projects/FPA-328      ─┘
/home/tomek/.dotfiles              ── Division: "dotfiles"
```

Divisions affect map placement — platoons in the same division cluster in the same biome zone. A taller division banner marks each zone.

The API response gains a `divisions` array:
```json
{
  "divisions": [
    {
      "id": "projects",
      "commonPath": "/home/tomek/projects",
      "groupIds": ["SimExLab", "Q1TouchPoint", "FPA-328"]
    }
  ]
}
```

### 2.3 Dynamic Formations

Unit arrangement around buildings responds to platoon state composition:

- **Battle formation** (majority active): Tight rows close to building, facing outward. Energetic animations at full speed.
- **Rest formation** (majority idle/awaiting): Loose scatter, wider radius. Slower animations. Some units sitting (reduced Y-scale).
- **Camp formation** (majority stale): Units cluster around an auto-spawned campfire mesh (point light + small cone embers). Slumped, dim.

Formation transitions are smooth — units lerp to new anchor positions over 2 seconds when the platoon state mix shifts.

### 2.4 Platoon Health Bar

A floating bar above each building (below the name label). Three segments, proportional to unit count:
- Green (active), Gold (awaiting), Grey (idle/stale)
- Width: 1.5 world units. Height: thin.
- Implemented as a simple `PlaneGeometry` with a custom `ShaderMaterial` or three adjacent planes.
- Visible at all zoom levels.

### 2.5 Reinforcements & Gravestones

- **Spawn:** New units march in from the nearest map edge along the path network. Dust particles along the route. Takes ~2 seconds to arrive.
- **Death:** Unit fades out over 1 second. A small gravestone mesh (tiny box + cross) appears at their position, fades out over 60 seconds. Provides visual history of churn.

---

## Pillar 3: The Characters — Identity & Personality

### 3.1 Unit Classes

Derived from backend signals (CPU, has_children, age, state):

| Class | Conditions | Visual | Colour Accent |
|-------|-----------|--------|---------------|
| **Builder** | active + has_children | Stockier body (wider cylinder), hammer accessory | Orange apron |
| **Scholar** | active + no children | Taller body (taller cylinder), floating book | Blue robes |
| **Scout** | age < 2 minutes | Smaller scale (0.8x), lantern accessory | Green trim |
| **Sentinel** | awaiting state | Normal body, shield accessory, pulsing gold ring | Gold sash |
| **Veteran** | age > 1 hour + active | Normal body, cape (flat plane behind body) | Purple trim |
| **Ghost** | stale state | Translucent (0.3 opacity), no accessory, drift animation | None |

Class is re-evaluated each poll cycle — a Scholar who starts running tests becomes a Builder. Visual transition is smooth (accessory swap with a brief particle puff).

### 3.2 Persistent Names

Each PID gets a deterministic medieval name via a hash-to-name lookup table:

```javascript
const NAMES = [
  "Aldric", "Bronwyn", "Cedric", "Daphne", "Edric",
  "Freya", "Gareth", "Helena", "Isolde", "Jasper",
  "Kiera", "Leoric", "Maren", "Nolan", "Orin",
  "Petra", "Quinn", "Rowan", "Sable", "Theron",
  "Una", "Valen", "Wren", "Xara", "Yorick", "Zara"
  // ... extend to 100+ names
];

function nameFromPid(pid) {
  return NAMES[pid % NAMES.length];
}
```

Name appears on hover (tooltip), in selection panel, and at close zoom levels as a tiny CSS2D label below the unit.

### 3.3 Rank Badges

Based on session age:

| Rank | Age | Visual |
|------|-----|--------|
| Recruit | < 5 min | No badge |
| Apprentice | 5-30 min | Bronze pip (tiny sphere, y=0.7) |
| Journeyman | 30 min - 2h | Silver pip |
| Master | 2h+ | Gold pip |

Pip mesh: `SphereGeometry(0.03)` with emissive material at appropriate colour. Positioned above the head.

### 3.4 Size Scaling by Memory

Memory usage maps to unit scale:
- `< 100MB` → scale 0.9
- `100-300MB` → scale 1.0 (default)
- `300-500MB` → scale 1.1
- `> 500MB` → scale 1.2

Smooth lerp when memory changes. Subtle enough to notice, not cartoonish.

---

## Pillar 4: The Intelligence — Stats & Metrics

### 4.1 War Room Panel

Toggleable via `Tab` key or clicking Town Hall. Slides in from the right, occupying ~350px width. Semi-transparent dark background matching the selection panel style.

Sections:

**Army Overview:**
- Total sessions, total CPU %, total memory
- Uptime distribution: horizontal bar chart showing how many sessions in each age bracket
- Pie/ring chart: state distribution (active/awaiting/idle/stale)

**Platoon Leaderboard:**
- Table sorted by "activity score" (weighted: active=3, awaiting=1, idle=0, stale=-1)
- Columns: Platoon name, unit count, active count, avg CPU, total memory
- Row highlight colours matching platoon accent

**Idle Alert Feed:**
- Scrolling log (last 20 entries) of state transitions
- Format: `14:32 Aldric (SimExLab) → awaiting`
- Colour-coded by target state
- Newest at top

### 4.2 Idle Economics

The hero metric. Displayed prominently in the HUD bar and War Room:

**"Agent-minutes awaiting: X"** — cumulative time all sessions have spent in `awaiting` state since page load.

Calculated: for each session, track time spent in awaiting state. Sum across all sessions. Update every poll cycle.

Secondary metric: **"Longest wait: Aldric (SimExLab) — 4m 32s"** — the session that's been awaiting longest right now. This is the one you should alt-tab to.

### 4.3 Heatmap Mode

Toggle via `H` key. The terrain tiles change colour based on CPU activity of nearby sessions:

- Hot (total CPU > 100%): deep red/orange
- Warm (50-100%): warm orange
- Cool (10-50%): yellow-green
- Cold (< 10%): cool blue

Implementation: on toggle, iterate all tiles, find nearest building, sum CPU of sessions in that group, map to colour gradient. Update each poll cycle. Smooth colour transitions.

Buildings and units remain visible on top. Effectively a thermal overlay on the terrain.

### 4.4 Timeline Sparklines

In the selection panel (both unit and group views), show a sparkline chart of CPU over the last 2 minutes.

- Width: 120px, Height: 24px
- Rendered as an SVG `<polyline>` in the panel HTML
- Data: last 60 readings (at 2s intervals = 2 minutes)
- Line colour: green for active, gold for awaiting, grey otherwise
- Fill under the line with 20% opacity of the line colour

Backend change: the session store tracks a `cpuHistory` array per PID (last 60 readings). Included in the API response as `cpu_history: number[]`.

---

## Pillar 5: The Interaction

### 5.1 Box Select

Click-drag on empty space draws a selection rectangle:
- Visual: semi-transparent green rectangle overlay (CSS positioned div)
- On mouseup: convert screen rect corners to world-space rays, find all units whose screen-projected position falls within the rect
- Selected units get highlight glow
- Selection panel shows multi-unit summary

### 5.2 Shift-Click

Shift+click adds/removes a unit from the current selection. Standard RTS behaviour.

### 5.3 Double-Click

Double-click a unit → select all units of the same class on the map. Double-click a building → select all units in the same division.

### 5.4 Keyboard Hotkeys

| Key | Action |
|-----|--------|
| `Space` | Jump camera to most urgent unit (longest-awaiting) |
| `A` | Select all awaiting units |
| `Tab` | Toggle War Room panel |
| `H` | Toggle heatmap mode |
| `Q` / `E` | Rotate camera 90 degrees |
| `1`-`9` | Jump camera to platoon N |
| `Escape` | Deselect all, close panels |
| `F` | Focus/centre camera on current selection |
| `M` | Toggle minimap |

### 5.5 Minimap

150x150px canvas in the bottom-left corner:
- Renders a simplified top-down view of the map
- Terrain as coloured pixels (green/blue/brown)
- Buildings as white squares
- Units as coloured dots (state colour)
- White rectangle showing current viewport bounds
- Click to jump camera to that position
- Semi-transparent background, subtle border

### 5.6 Hover Tooltips

Hovering over a unit shows a floating card (HTML overlay, positioned via CSS2DRenderer logic):
- Unit name, class icon, rank badge
- Current state with colour indicator
- CPU %, Memory MB
- Uptime
- Platoon name

Styled as a parchment card with medieval flavour. Appears after 300ms hover delay, disappears immediately on mouseout.

---

## Pillar 6: The Polish

### 6.1 Particle Systems

All particles use `THREE.Points` with `PointsMaterial` or a simple `ShaderMaterial` for fade-out.

| Effect | Trigger | Particle Count | Behaviour |
|--------|---------|---------------|-----------|
| Builder sparks | Active + has_children | 8-12 | Orange, upward burst, 1s lifetime, near hands |
| Scholar pages | Active + no children | 3-5 | White, slow float upward, 3s lifetime, gentle drift |
| Sentinel rings | Awaiting state | 1 ring | Gold expanding ring on ground plane, 2s cycle, repeat |
| Ghost wisps | Stale state | 4-6 | Grey, trailing behind unit, 2s fade |
| Spawn dust | Unit marching in | 10-15 | Brown, burst at feet, 0.5s lifetime |
| Death motes | Unit removed | 8-10 | White/gold, upward scatter, 1.5s lifetime |
| Confetti | Victory state (all active) | 50-80 | Multi-colour, fountain burst from Town Hall, 3s |

### 6.2 Water Shader

Replace flat blue planes with animated water:
- Vertex displacement: two overlapping sine waves on Y axis (different frequencies/amplitudes)
- Material: `MeshPhongMaterial` with slight transparency (0.7), environment-blue colour
- Specular highlight to catch the directional light
- Very subtle — Townscaper-style gentle wobble, not ocean simulation

### 6.3 Day/Night Cycle

5-minute full cycle (configurable). Implemented by rotating the directional light around the scene and adjusting colours:

| Phase | Duration | Light Colour | Ambient | Sky (clearColor) |
|-------|----------|-------------|---------|-------------------|
| Dawn | 45s | Soft pink #FFB7A5 | 0.3 | #E8C8B8 |
| Day | 120s | Warm white #FFF5E6 | 0.4 | #E8E0D4 |
| Dusk | 45s | Deep orange #FF8C42 | 0.3 | #D4A574 |
| Night | 90s | Cool blue #4466AA | 0.15 | #1a1a2e |

At night:
- Building windows emit warm PointLights (turn on at dusk, off at dawn)
- Forge glow intensifies
- Unit emissive effects become more dramatic against dark terrain
- Stars: a distant `Points` geometry hemisphere above the scene

Light position traces a semicircle: `x = cos(phase), y = sin(phase)` mapped to the cycle.

### 6.4 Loading Screen

A full-screen HTML overlay shown before the scene initialises:
- Background: dark parchment (#1a1a2e)
- Title: "Age of the Crystal Ball" in Cinzel, gold, large
- Subtitle: "Scrying your realm..." in IBM Plex Mono, muted
- Crystal ball animation: CSS-only glowing orb (radial gradient + pulsing box-shadow)
- Progress bar: medieval scroll style (narrow, gold fill on dark track)
- Fades out over 500ms once first API response arrives and terrain is generated

### 6.5 Camera Intro

After loading screen fades:
1. Camera starts at `viewSize = 40` (very zoomed out), position high
2. Over 3 seconds, smooth-lerps to default `viewSize = 14`
3. Terrain tiles fade in with a wave pattern (centre outward, 50ms stagger per ring)
4. Buildings pop up with a slight bounce overshoot (scale 0 → 1.1 → 1.0)
5. Units march in from edges (see 2.5)

### 6.6 Sound Design

All sounds loaded as small audio files served from `/public/audio/`. Managed by a `SoundManager` class with master volume and mute toggle.

| Sound | Trigger | Character |
|-------|---------|-----------|
| Ambient loop | Always | Gentle medieval town: birds, distant anvil, wind |
| Idle chime | Session → awaiting | Soft bell chime, attention-grabbing but not alarming |
| Spawn horn | New unit appears | Short horn/trumpet note |
| Death tone | Unit removed | Low soft tone, fading |
| Victory fanfare | All sessions active | Brief celebratory medieval flourish |
| Click | UI interaction | Soft tap |

Muted by default (important for competition demos where presenter is talking). Speaker icon in HUD corner to toggle.

### 6.7 Post-Processing

`THREE.EffectComposer` with:

1. **Bloom pass:** `UnrealBloomPass` — threshold 0.8, strength 0.3, radius 0.4. Makes emissive materials glow beautifully (awaiting pulse, forge fire, crystal staffs, night-time window lights). The single biggest visual upgrade for minimal effort.
2. **Vignette:** Subtle darkening at screen edges. Custom shader or `ShaderPass` with a radial gradient. Strength ~0.3.
3. **Optional tilt-shift:** Blur at top and bottom edges to enhance miniature-world feeling. Very subtle. Can be toggled.

### 6.8 GR Victory Screen

When all sessions are simultaneously in `active` state (zero awaiting, zero idle, zero stale):
- HUD flashes "FULL DEPLOYMENT" in gold with a glow animation
- Confetti particles burst from Town Hall
- Victory fanfare sound (if unmuted)
- Lasts 5 seconds, then fades back to normal
- Re-triggers if the condition is met again after a cooldown

---

## Priority Matrix

### Must-Have (Week 1) — The Competition Killer

These features together transform V0 into a jaw-dropping demo:

| # | Feature | Pillar | Effort | Impact | Why must-have |
|---|---------|--------|--------|--------|---------------|
| 1 | Zoom in/out | P5 | Small | High | Basic expectation, enables detail viewing |
| 2 | Day/night cycle | P6 | Medium | Very high | Single biggest "alive" feeling upgrade |
| 3 | Bloom post-processing | P6 | Small | High | Makes everything glow beautifully |
| 4 | Unit classes + visuals | P3 | Medium | High | Characters feel individual and meaningful |
| 5 | Persistent names | P3 | Small | Medium | Charm, personality, "I recognise Aldric" |
| 6 | Rank badges | P3 | Small | Medium | Visual history at a glance |
| 7 | Loading screen + camera intro | P6 | Small | High | First impression wins competitions |
| 8 | Particle effects (core set) | P6 | Medium | High | Scene feels alive even when nothing changes |
| 9 | Box select + shift-click | P5 | Medium | High | "This is a real RTS" moment |
| 10 | Idle economics (agent-minutes) | P4 | Small | Very high | The "useful" killer feature, demo talking point |
| 11 | Platoon health bars | P2 | Small | High | Instant readability from any zoom |
| 12 | Keyboard hotkeys | P5 | Small | Medium | Professional feel, demo speed |
| 13 | Water animation | P6 | Small | Medium | Map feels alive |
| 14 | Biome system | P1 | Medium | High | Map becomes screenshot-worthy |
| 15 | Real process discovery (macOS) | — | Medium | Critical | Must work with real sessions for demo |

### Should-Have (Week 2 / if time allows)

| # | Feature | Pillar | Effort | Impact |
|---|---------|--------|--------|--------|
| 16 | War Room panel | P4 | Medium | High |
| 17 | Heatmap mode | P4 | Medium | High |
| 18 | Camera rotation (90 degree snap) | P1 | Medium | Medium |
| 19 | Minimap | P5 | Medium | High |
| 20 | Sparkline CPU history | P4 | Medium | Medium |
| 21 | Sound design | P6 | Medium | High |
| 22 | Hover tooltips | P5 | Small | Medium |
| 23 | Reinforcement march-in animation | P2 | Medium | High |
| 24 | Gravestone death animation | P2 | Small | Medium |
| 25 | GR Town Hall central building | P1 | Small | Medium |
| 26 | Division auto-inference | P2 | Medium | Medium |
| 27 | Dynamic formations | P2 | Medium | Medium |
| 28 | Victory screen | P6 | Small | Medium |
| 29 | Vignette + tilt-shift | P6 | Small | Medium |
| 30 | Memory-based size scaling | P3 | Small | Low |
| 31 | Double-click class select | P5 | Small | Low |
| 32 | Tree/rock decoration meshes | P1 | Medium | Medium |

### Nice-to-Have (Stretch)

| # | Feature | Pillar | Effort | Impact |
|---|---------|--------|--------|--------|
| 33 | Path auto-generation (A*) | P1 | High | Medium |
| 34 | Stars at night | P6 | Small | Low |
| 35 | Tilt-shift DoF | P6 | Small | Low |
| 36 | Class transition particle puff | P3 | Small | Low |
| 37 | Real process discovery (Linux) | — | Medium | Conditional |

---

## Technical Architecture Changes for V1

### Backend Additions

```
server/
  discovery/
    simulator.js    # Enhanced: class hints, cpu_history, divisions
    macos.js        # NEW: real macOS process discovery
  classifier.js     # Enhanced: class inference from signals
  sessionStore.js   # Enhanced: cpu_history tracking, division grouping, idle economics
```

API response gains:
- `cpu_history: number[]` per session (last 60 readings)
- `class: string` per session (builder/scholar/scout/sentinel/ghost)
- `name: string` per session (deterministic from PID)
- `divisions: Array<{ id, commonPath, groupIds }>` top-level
- `metrics.awaitingAgentMinutes: number` top-level

### Frontend Additions

```
public/js/
  particles.js      # NEW: particle system manager
  daynight.js       # NEW: day/night cycle controller
  postprocessing.js  # NEW: bloom + vignette setup
  heatmap.js        # NEW: heatmap overlay toggle
  warroom.js        # NEW: War Room panel DOM + updates
  minimap.js        # NEW: minimap canvas renderer
  sound.js          # NEW: SoundManager
  loading.js        # NEW: loading screen + camera intro
  hotkeys.js        # NEW: keyboard shortcut handler
  tooltips.js       # NEW: hover tooltip system
```

### Testing Strategy

Every new module gets unit tests:
- `particles.test.js` — particle lifecycle, spawn/despawn
- `daynight.test.js` — phase calculation, colour interpolation
- `classifier.test.js` — class inference from signals (extended)
- `sessionStore.test.js` — cpu_history, division grouping, idle economics
- `simulator.test.js` — enhanced output validation
- `api.test.js` — new response shape fields
- Integration: `npm run simulate` smoke test after each pillar

---

## Implementation Phases

### Phase 1: Core Visual Upgrade (Days 1-3)
Features: #1 zoom, #2 day/night, #3 bloom, #7 loading screen, #13 water, #14 biomes

### Phase 2: Characters & Army (Days 3-5)
Features: #4 classes, #5 names, #6 ranks, #11 health bars, #8 particles

### Phase 3: Interaction & Intelligence (Days 5-7)
Features: #9 box select, #10 idle economics, #12 hotkeys, #15 real process discovery

### Phase 4: Polish & Stretch (Days 8-10)
Features: #16-32 from should-have list, prioritised by impact
